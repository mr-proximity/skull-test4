<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Skeletal System</title>
    <style>
        :root {
            --glow-color: #00a2ff;
            --header-height: 45px; /* Approximate height for positioning */
            --sidebar-width: 350px; /* Width of the info sidebar */
        }

        body {
            background-color: #000;
            /* Blue grid background - Adjusted */
            background-image:
                linear-gradient(to right, rgba(0, 162, 255, 0.2) 1.5px, transparent 1.5px), /* Thicker lines, increased alpha */
                linear-gradient(to bottom, rgba(0, 162, 255, 0.2) 1.5px, transparent 1.5px); /* Thicker lines, increased alpha */
            background-size: 20px 20px; /* Size of the grid squares */
            margin: 0;
            /* Use Calibri or fallbacks */
            font-family: Calibri, Candara, Segoe, "Segoe UI", Optima, Arial, sans-serif;
            display: flex;
            /* Keep body flex for potential future centering needs, but manage layout with header/container/sidebar */
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Header Styles */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background-color: #000;
            color: #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 5000;
            border-bottom: 1px solid #222; /* Subtle separator */
        }

        .header-title {
            font-size: 1.1em; /* Relatively small */
            font-weight: bold;
            color: var(--glow-color);
            text-transform: uppercase;
            cursor: pointer; /* Indicate it's clickable */
        }

        nav.center-nav a,
        nav.right-nav a {
            color: #ccc;
            text-decoration: none;
            margin: 0 12px;
            font-size: 0.9em; /* Smaller than title */
            transition: color 0.2s ease, text-shadow 0.2s ease;
            cursor: pointer;
        }

        nav.center-nav a:hover,
        nav.right-nav a:hover {
            color: #fff;
            text-shadow: 0 0 8px var(--glow-color); /* Subtle glow */
        }

        /* Main Content Area (pushes below header) */
        .main-content {
            margin-top: var(--header-height);
            flex-grow: 1; /* Takes remaining vertical space */
            display: flex; /* Use flex to position container and sidebar */
            justify-content: center; /* Center the skeleton container */
            align-items: center;
            position: relative; /* Needed for container positioning */
            width: 100%;
            overflow: hidden; /* Prevents container from overflowing */
        }

        /* Skeleton Container */
        .container {
            position: relative; /* Absolute positioning for layers */
            margin: 20px; /* Add some margin around the skeleton */
            cursor: default;
            transition: transform 0.5s ease-in-out; /* For potential future zoom */
            /* Max width/height to prevent huge images breaking layout */
            max-width: calc(100vw - var(--sidebar-width) - 60px); /* Consider sidebar and margins */
            max-height: calc(100vh - var(--header-height) - 40px); /* Consider header and margins */
            flex-shrink: 0; /* Prevent container from shrinking */
        }

        .container img.anatomy-layer { /* Ensure layers scale with container */
             max-width: 100%;
             max-height: 100%;
             width: auto; /* Maintain aspect ratio */
             height: auto;
        }


        .anatomy-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Initially, layers are not directly clickable */
            user-select: none;
            -webkit-user-drag: none;
            transition: filter 0.15s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1; /* Default opacity */
        }

        .anatomy-layer.hidden {
            opacity: 0;
            pointer-events: none; /* Ensure hidden layers don't interfere */
        }

        .anatomy-layer.interactive {
            pointer-events: auto; /* Enable pointer events for interactive layers */
        }


        /* Canvas used ONLY for pixel data */
        .hit-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            visibility: hidden;
        }

        .glowing {
            filter: drop-shadow(0 0 15px var(--glow-color));
        }

        /* Loading Indicator */
        #loading {
            color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            z-index: 10000;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 8px;
            text-align: center;
        }
         #loading progress {
             width: 80%;
             margin-top: 10px;
         }

        /* Sidebar (was #info-popup) */
        #sidebar {
            position: fixed;
            right: 0;
            top: var(--header-height); /* Position below header */
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height)); /* Full height below header */
            background-color: rgba(15, 15, 15, 0.98); /* Dark background */
            color: #eee;
            border-left: 1px solid #333;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
            z-index: 4000; /* Below header, above content */
            transform: translateX(100%); /* Start hidden off-screen */
            transition: transform 0.4s ease-in-out;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }

        #sidebar.visible {
            transform: translateX(0); /* Slide in */
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header shrinking */
        }

        .sidebar-header h4 {
            margin: 0;
            color: var(--glow-color);
            font-size: 1.3em;
        }

        .sidebar-close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.8em;
            line-height: 1;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s ease;
        }

        .sidebar-close-btn:hover {
            color: #fff;
        }

        .sidebar-content {
            padding: 20px;
            overflow-y: auto; /* Enable scrolling for long content */
            flex-grow: 1; /* Allow content to take available space */
        }

        .sidebar-content img.popup-gif,
        .sidebar-content img.popup-image {
            max-width: 100%;
            height: auto;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #222; /* Placeholder bg */
        }

        .sidebar-content h5 { /* Sub-headings */
             color: #bbb;
             margin-top: 20px;
             margin-bottom: 8px;
             border-bottom: 1px solid #333;
             padding-bottom: 4px;
         }

         .sidebar-content p {
             font-size: 0.95em;
             line-height: 1.6;
             margin-bottom: 15px;
             color: #ccc;
         }
          .sidebar-content a {
             color: var(--glow-color);
             text-decoration: none;
         }
         .sidebar-content a:hover {
             text-decoration: underline;
         }
         .sidebar-content ul {
             list-style: none;
             padding-left: 0;
         }
         .sidebar-content li {
              margin-bottom: 8px;
              font-size: 0.9em;
              color: #bbb;
          }
           .sidebar-content .credits {
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #333;
                font-size: 0.8em;
                color: #888;
            }
            .sidebar-content .credits h5 {
                color: #aaa;
                margin-bottom: 10px;
            }

    </style>
</head>
<body>
    <header>
        <div class="header-title">SKELETAL SYSTEM</div>
        <nav class="center-nav">
            <a href="#" data-mode="arthritis">Arthritis</a>
            <a href="#" data-mode="osteoporosis">Osteoporosis</a>
            <a href="#" data-mode="osteomyelitis">Osteomyelitis</a>
            <a href="#" data-mode="scoliosis">Scoliosis</a>
            <a href="#" data-mode="rickets">Rickets</a>
        </nav>
        <nav class="right-nav">
            <a href="https://ashish102005.github.io/kurkure/" target="_blank" rel="noopener noreferrer">Take a Quiz</a>
            <a href="#" data-mode="about">About</a>
        </nav>
    </header>

    <div class="main-content">
        <div class="container" id="container">
            </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h4 id="sidebar-title">Information</h4>
            <button class="sidebar-close-btn" id="sidebar-close-btn" aria-label="Close sidebar">&times;</button>
        </div>
        <div class="sidebar-content" id="sidebar-content">
            </div>
    </div>

    <div id="loading">
          Loading Assets...
          <progress id="loading-progress" value="0" max="100"></progress>
      </div>

    <script>
        // --- CONFIGURATION ---

        const BASE_LAYER_ID = 'base'; // Default base layer ID
        const DEFAULT_BASE_IMAGE = 'test.png'; // Default base image filename

        const skeletonLayers = [
             // Base layer is handled separately now
             { id: 'skull', src: 'skull.png', name: 'Skull', interactive: true, gifSrc: 'skull.gif', info: 'The skull protects the brain and provides structure to the face. Made up of 22 bones, it is divided into the cranium (braincase) and facial bones.' },
             { id: 'spine', src: 'spine.png', name: 'Spine', interactive: true, gifSrc: 'spine.gif', info: 'The spine, or vertebral column, consists of 33 vertebrae. It supports the body, allows movement, and protects the spinal cord.' },
             { id: 'ribcage', src: 'ribcage.png', name: 'Ribcage', interactive: true, gifSrc: 'ribcage.gif', info: 'Typically consisting of 12 pairs of ribs, the sternum, and thoracic vertebrae, the ribcage protects vital organs like the heart and lungs.' }, // Assuming a generic ribcage gif if available
             { id: 'pelvis', src: 'pelvis.png', name: 'Pelvis', interactive: true, gifSrc: 'pelvis.gif', info: 'The pelvis connects the spine to the legs and supports abdominal organs. It is formed by the hip bones, sacrum, and coccyx.' }, // Assuming a generic pelvis gif
             { id: 'right-arm', src: 'right-arm.png', name: 'Right Arm Bones', interactive: true, gifSrc: 'arm.gif', info: 'Includes the humerus (upper arm), and the radius and ulna (forearm). These bones facilitate a wide range of movements.' },
             { id: 'left-arm', src: 'left-arm.png', name: 'Left Arm Bones', interactive: true, gifSrc: 'arm.gif', info: 'Includes the humerus (upper arm), and the radius and ulna (forearm). Structurally similar to the right arm.' },
             { id: 'hands', src: 'hands.png', name: 'Hand Bones', interactive: true, gifSrc: 'hands.gif', info: 'Each hand has 27 bones: carpals (wrist), metacarpals (palm), and phalanges (fingers), allowing for dexterity.' },
             { id: 'thighs', src: 'thighs.png', name: 'Thigh Bone (Femur)', interactive: true, gifSrc: 'femur.gif', info: 'The femur is the longest, heaviest, and strongest bone in the human body, connecting the hip to the knee.' },
             { id: 'lower-leg', src: 'lower-leg.png', name: 'Lower Leg Bones', interactive: true, gifSrc: 'tibia.gif', info: 'Comprises the tibia (shin bone), which bears most of the weight, and the fibula. They connect the knee to the ankle.' },
             { id: 'feet', src: 'feet.png', name: 'Foot Bones', interactive: true, gifSrc: 'feet.gif', info: 'Each foot contains 26 bones: tarsals (ankle), metatarsals (midfoot), and phalanges (toes), providing support and enabling locomotion.' }
        ];

         // Disease definitions
         const diseaseInfo = {
             arthritis: {
                 name: 'Arthritis',
                 baseImage: 'arthritis-test.png', // Specific base image
                 extraLayers: [{ id: 'arthritis-hand', src: 'arthritis-hand.png', zIndex: 1000 }], // Example extra layer
                 popupImage: 'arthritis-popj.jpeg',
                 info: 'Arthritis is the swelling and tenderness of one or more joints. The main symptoms are joint pain and stiffness, which typically worsen with age. Common types include osteoarthritis and rheumatoid arthritis. <br><br> Treatments vary depending on the type but may include medications, physical therapy, or surgery. Lifestyle changes can also help manage symptoms.',
                 links: [{ text: 'More on Arthritis (Mayo Clinic)', url: 'https://www.mayoclinic.org/diseases-conditions/arthritis/symptoms-causes/syc-20350772' }]
             },
             osteoporosis: {
                 name: 'Osteoporosis',
                 baseImage: 'osteoporosis-test.png', // Specific base image
                 extraLayers: [{ id: 'osteoporosis-arm', src: 'osteoporosis-arm.png', zIndex: 1000 }],
                 popupImage: 'osteoporosis-pop.jpeg',
                 info: 'Osteoporosis causes bones to become weak and brittle — so brittle that a fall or even mild stresses such as bending over or coughing can cause a fracture. Osteoporosis-related fractures most commonly occur in the hip, wrist or spine.<br><br>Treatment includes medication, healthy diet, and weight-bearing exercise to help prevent bone loss or strengthen already weak bones.',
                 links: [{ text: 'Osteoporosis Overview (NIH)', url: 'https://www.niams.nih.gov/health-topics/osteoporosis' }]
             },
             osteomyelitis: {
                 name: 'Osteomyelitis',
                 baseImage: DEFAULT_BASE_IMAGE, // Uses default base image
                 extraLayers: [{ id: 'osteomyelitis-arm', src: 'osteomyelitis-arm.png', zIndex: 1000 }],
                 popupImage: 'osteomyelitis-pop.png',
                 info: 'Osteomyelitis is an infection in a bone. Infections can reach a bone by traveling through the bloodstream or spreading from nearby tissue. Infections can also begin in the bone itself if an injury exposes the bone to germs.<br><br>Treatment often involves surgery to remove parts of the bone that have died, followed by strong antibiotics, often intravenously.',
                 links: [{ text: 'Learn about Osteomyelitis (MSD Manual)', url: 'https://www.msdmanuals.com/home/bone,-joint,-and-muscle-disorders/bone-infections/osteomyelitis' }]
             },
             scoliosis: {
                 name: 'Scoliosis',
                 baseImage: 'scoliosis.png', // Specific base image
                 extraLayers: [], // No extra layers specified
                 popupImage: 'scoliosis-popj.jpeg',
                 info: 'Scoliosis is a sideways curvature of the spine that most often is diagnosed in adolescents. While scoliosis can occur in people with conditions such as cerebral palsy and muscular dystrophy, the cause of most childhood scoliosis is unknown.<br><br>Treatment depends on the severity of the curve. Options include observation, bracing, or surgery.',
                 links: [{ text: 'Scoliosis Information (SRS)', url: 'https://www.srs.org/patients-and-families/conditions-and-treatments/parents/scoliosis' }]
             },
             rickets: {
                 name: 'Rickets',
                 baseImage: 'rickets-test.png', // Specific base image
                 extraLayers: [{ id: 'rickets-layer', src: 'rickets.png', zIndex: 1000 }], // Renamed id for clarity
                 popupImage: 'rickets-popj.jpeg',
                 info: 'Rickets is the softening and weakening of bones in children, usually because of an extreme and prolonged vitamin D deficiency. Adding vitamin D or calcium to the diet generally corrects the bone problems associated with rickets.<br><br>Rare inherited problems also can cause rickets. For these, specific medications or other management might be needed.',
                 links: [{ text: 'Rickets Explained (KidsHealth)', url: 'https://kidshealth.org/en/parents/rickets.html' }]
             },
             about: {
                 name: 'About This Project',
                 baseImage: DEFAULT_BASE_IMAGE, // Keep default base image visible
                 extraLayers: [], // No extra layers
                 popupImage: null, // No specific image for about
                 info: `<h5>Skeletal System as Scaffold</h5>
                     <p>This interactive tool explores the human skeletal system, the vital framework that supports our bodies, protects our organs, and enables movement. Explore different bones and learn about common conditions affecting skeletal health.</p>
                     <div class="credits">
                         <h5>Project Credits</h5>
                         <ul>
                             <li>10484 - Ashish Kori</li>
                             <li>10483 - Samruddhi Khapare</li>
                             <li>10474 - Darshan Bhoir</li>
                             <li>10476 - Jayesh Devlekar</li>
                             <li>10477 - Paras Dhende</li>
                             <li>10479 - Manomay Ghadi</li>
                             <li>10480 - Isha Madhialagan</li>
                             <li>10482 - Sayli Kargutkar</li>
                             <li>10478 - Jess Demello</li>
                             <li>10481 - Abhinav Jha</li>
                             <li>10475 - Luke Cabral</li>
                         </ul>
                     </div>` // Added credits directly here
             }
         };

        // --- DOM References ---
        const container = document.getElementById('container');
        const loadingIndicator = document.getElementById('loading');
         const loadingProgress = document.getElementById('loading-progress');
        const sidebar = document.getElementById('sidebar');
        const sidebarTitle = document.getElementById('sidebar-title');
        const sidebarContent = document.getElementById('sidebar-content');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const header = document.querySelector('header');
        const headerTitleElement = header.querySelector('.header-title'); // Get the title element

        // --- State ---
        const imageElements = {}; // Holds <img> elements for layers
        const canvasElements = {}; // Holds <canvas> for hit detection
        const canvasContexts = {}; // Holds 2D contexts
        let assetsToLoad = 0;
         let assetsLoaded = 0;
        let activeLayerId = null; // ID of hovered skeleton part
        let currentMode = 'default'; // 'default', 'arthritis', etc.
        let baseImageNaturalWidth = 0;
         let baseImageNaturalHeight = 0;

        // --- Initialization ---

        function init() {
            console.log("Initializing...");
            setupHeaderListeners();
            sidebarCloseBtn.addEventListener('click', closeSidebar);

            // Collect all unique image URLs to preload
            const imageUrls = new Set();
            imageUrls.add(DEFAULT_BASE_IMAGE); // Add default base
             skeletonLayers.forEach(l => {
                 if (l.src) imageUrls.add(l.src);
                 if (l.gifSrc) imageUrls.add(l.gifSrc);
            });
            Object.values(diseaseInfo).forEach(d => {
                 if (d.baseImage) imageUrls.add(d.baseImage);
                 if (d.popupImage) imageUrls.add(d.popupImage);
                 d.extraLayers.forEach(el => {
                     if (el.src) imageUrls.add(el.src);
                });
            });


            assetsToLoad = imageUrls.size;
            console.log(`Need to load ${assetsToLoad} assets.`);
             loadingProgress.max = assetsToLoad;

             if (assetsToLoad === 0) {
                 setupScene(); // No assets to load? Unlikely but possible
                 return;
             }

             // Create base layer img element first
             createLayerElement({ id: BASE_LAYER_ID, src: DEFAULT_BASE_IMAGE, name: 'Base Body', interactive: false, zIndex: 0 });

             // Create elements for skeleton layers
             skeletonLayers.forEach((layer, index) => {
                 createLayerElement({ ...layer, zIndex: index + 1 }); // Ensure skeleton is above base
             });

             // Create elements for disease extra layers (initially hidden)
             Object.values(diseaseInfo).forEach(disease => {
                 disease.extraLayers.forEach(layerInfo => {
                     createLayerElement({ ...layerInfo, interactive: false, initiallyHidden: true });
                 });
             });

            // Start preloading
            imageUrls.forEach(url => preloadImage(url));
        }

         function createLayerElement(layerData) {
             const img = new Image();
             img.className = 'anatomy-layer';
             img.id = `${layerData.id}-layer`; // Unique ID for image element
             img.alt = layerData.name || layerData.id;
             img.style.zIndex = layerData.zIndex === undefined ? 1 : layerData.zIndex; // Default zIndex 1
             if (layerData.initiallyHidden) {
                 img.classList.add('hidden'); // Hide layers meant for specific modes initially
             }
             if (layerData.interactive) {
                 img.classList.add('interactive'); // Add interactive class for mouse events
             }
             imageElements[layerData.id] = img; // Store reference by layer ID
             container.appendChild(img);

             // Add hit canvas only for interactive skeleton layers in default mode
             // Disease specific layers might also be interactive, but their hit detection
             // logic might differ or not be needed if they only appear in a specific mode.
             // For now, only create canvases for the main skeleton interactive layers.
             if (layerData.interactive && skeletonLayers.some(sl => sl.id === layerData.id)) {
                 const canvas = document.createElement('canvas');
                 canvas.className = 'hit-canvas';
                 canvas.id = `${layerData.id}-canvas`; // Unique ID for canvas
                 canvas.style.zIndex = (layerData.zIndex || 1) + 100; // Ensure canvas is visually behind but logically checked
                 canvasElements[layerData.id] = canvas;
                 container.appendChild(canvas);
             }
         }

        function preloadImage(url) {
            const img = new Image();
            img.onload = () => assetLoadHandler(url);
            img.onerror = () => assetErrorHandler(url);
            img.src = url;
        }

        function assetLoadHandler(url) {
            console.log(`Loaded: ${url}`);
            assetsLoaded++;
             updateLoadingProgress();
            checkAllAssetsLoaded();
        }

        function assetErrorHandler(url) {
            showError(`Failed to load asset: ${url}`, false);
            console.error(`Failed to load asset: ${url}`);
            assetsLoaded++; // Count as loaded (even though failed) to proceed
             updateLoadingProgress();
            checkAllAssetsLoaded();
        }

         function updateLoadingProgress() {
             loadingProgress.value = assetsLoaded;
             if (loadingIndicator.style.display !== 'none') {
               loadingIndicator.firstChild.textContent = ` Loading Assets... (${assetsLoaded}/${assetsToLoad}) `;
             }
         }


        function checkAllAssetsLoaded() {
            if (assetsLoaded === assetsToLoad) {
                console.log("All assets processed. Setting up scene.");
                // Set the src for the already created img elements *after* loading
                 imageElements[BASE_LAYER_ID].src = DEFAULT_BASE_IMAGE; // Ensure default base has correct src
                 skeletonLayers.forEach(layer => {
                     if (imageElements[layer.id]) imageElements[layer.id].src = layer.src;
                  });
                 Object.values(diseaseInfo).forEach(disease => {
                     disease.extraLayers.forEach(layerInfo => {
                         if (imageElements[layerInfo.id]) imageElements[layerInfo.id].src = layerInfo.src;
                     });
                 });
                 // Wait briefly for images to render from cache before setup
                  setTimeout(setupScene, 100);
            }
        }

        function setupScene() {
            console.log("Setting up scene...");
            const baseImg = imageElements[BASE_LAYER_ID];

            if (!baseImg || !baseImg.complete || baseImg.naturalWidth === 0) {
                 showError("Base image missing or invalid after loading. Cannot initialize.", true);
                 return;
             }

             baseImageNaturalWidth = baseImg.naturalWidth;
             baseImageNaturalHeight = baseImg.naturalHeight;

            // Set container size based on the *default* base image
            container.style.width = baseImageNaturalWidth + 'px';
            container.style.height = baseImageNaturalHeight + 'px';

            let initializationSuccess = true;

            // Initialize interactive skeleton layers (draw images to their canvases)
             skeletonLayers.forEach(layer => {
                 if (!layer.interactive) return; // Skip non-interactive

                 const img = imageElements[layer.id];
                 const canvas = canvasElements[layer.id]; // Get the specific canvas for this layer

                 if (!img || !canvas || !img.complete || img.naturalWidth === 0) {
                     console.warn(`Skipping canvas setup for ${layer.id} due to image issues.`);
                     initializationSuccess = false; // Mark as partial success
                     return;
                 }

                 // Use natural dimensions of the specific layer image for its canvas
                 canvas.width = img.naturalWidth;
                 canvas.height = img.naturalHeight;

                 const ctx = canvas.getContext('2d', { willReadFrequently: true });
                 if (!ctx) {
                      console.error(`Could not get 2D context for ${layer.id}`);
                      initializationSuccess = false; // Mark as partial success
                      return;
                  }
                 try {
                      // Draw the image onto its corresponding canvas
                      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                      canvasContexts[layer.id] = ctx;
                      console.log(`Canvas drawn for: ${layer.id}`);
                  } catch (e) {
                      console.error(`Error drawing image to canvas for ${layer.id}:`, e);
                      initializationSuccess = false; // Mark as partial success
                  }
             });

            if(initializationSuccess) {
                // Only add mouse listeners if canvas setup was successful for interactive parts
                container.addEventListener('mousemove', handleContainerMouseMove);
                container.addEventListener('mouseleave', handleContainerMouseLeave);
                container.addEventListener('click', handleContainerClick);
                loadingIndicator.style.display = 'none';
                console.log("Initialization complete.");
            } else {
                 showError("Initialization failed for some interactive layers. Interaction may be incomplete.", true);
                 loadingIndicator.style.display = 'none'; // Hide loading even on partial failure
             }
        }

        // --- Header and Mode Switching ---

        function setupHeaderListeners() {
            header.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.dataset.mode) {
                     e.preventDefault();
                     const mode = e.target.dataset.mode;
                     // Don't switch mode if clicking 'about' and sidebar is already open for about
                     if (mode === 'about' && sidebar.classList.contains('visible') && currentMode === 'about') {
                         closeSidebar();
                     } else {
                         setMode(mode);
                     }
                } else if (e.target.classList.contains('header-title')) {
                     // Reload the page when the title is clicked
                     location.reload();
                 }
            });
        }

        function setMode(mode) {
             console.log(`Setting mode to: ${mode}`);
             // Reset active layer glow
             handleContainerMouseLeave();
             closeSidebar(); // Close sidebar when switching modes

             currentMode = mode;

             const disease = diseaseInfo[mode];

             // Manage visibility of base layer and disease-specific layers
             const defaultBaseLayerImg = imageElements[BASE_LAYER_ID];

             if (mode === 'default') {
                 // Show default base image and skeleton layers
                 if (defaultBaseLayerImg) defaultBaseLayerImg.classList.remove('hidden');
                 skeletonLayers.forEach(layer => {
                     if (imageElements[layer.id]) imageElements[layer.id].classList.remove('hidden');
                 });
                 // Hide all disease-specific extra layers
                 Object.values(diseaseInfo).forEach(d => {
                     d.extraLayers.forEach(l => {
                         if (imageElements[l.id]) imageElements[l.id].classList.add('hidden');
                     });
                 });
                 // Ensure interactive skeleton layers have pointer events enabled
                 skeletonLayers.forEach(layer => {
                    if (layer.interactive && imageElements[layer.id]) {
                        imageElements[layer.id].classList.add('interactive');
                    }
                 });


             } else if (disease) {
                 // Hide the default base image if a specific base image is defined for the disease
                 if (disease.baseImage !== DEFAULT_BASE_IMAGE && defaultBaseLayerImg) {
                      defaultBaseLayerImg.classList.add('hidden');
                 } else if (defaultBaseLayerImg) {
                     // Ensure default base is visible if the disease uses it
                     defaultBaseLayerImg.classList.remove('hidden');
                 }

                 // Hide all skeleton layers (except maybe the base if used)
                 skeletonLayers.forEach(layer => {
                     if (imageElements[layer.id] && layer.id !== BASE_LAYER_ID) {
                         imageElements[layer.id].classList.add('hidden');
                     }
                 });

                 // Show the disease-specific base image (if different from default)
                 if (disease.baseImage && disease.baseImage !== DEFAULT_BASE_IMAGE) {
                      const diseaseBaseImg = imageElements[Object.keys(imageElements).find(key => imageElements[key].src.endsWith(disease.baseImage))];
                      if(diseaseBaseImg) diseaseBaseImg.classList.remove('hidden');
                 }

                 // Show disease-specific extra layers
                 disease.extraLayers.forEach(l => {
                     if (imageElements[l.id]) imageElements[l.id].classList.remove('hidden');
                 });

                 // Disable pointer events on all layers in disease mode unless explicitly needed (not requested yet)
                  // For now, just remove interactive class from skeletal layers
                 skeletonLayers.forEach(layer => {
                    if (layer.interactive && imageElements[layer.id]) {
                        imageElements[layer.id].classList.remove('interactive');
                    }
                 });

                 // For disease modes, open the sidebar with relevant info
                 if (mode !== 'about') { // About mode is handled separately
                     showSidebar(disease.name, disease.popupImage, disease.info, disease.links);
                 }


             }

              // Handle 'about' mode separately
              if (mode === 'about') {
                  // Ensure default view is shown while the sidebar is open
                  setMode('default'); // Revert to default view
                  showSidebar(diseaseInfo.about.name, diseaseInfo.about.popupImage, diseaseInfo.about.info);
              }

         }


        // --- Mouse Interaction (Default Mode Only) ---

        function handleContainerMouseMove(event) {
             if (currentMode !== 'default' || loadingIndicator.style.display !== 'none') {
                 return; // Only active in default mode and when loaded
             }

             const rect = container.getBoundingClientRect();
             // Scale coordinates to the natural size of the base image (which dictates container size)
             const scaleX = baseImageNaturalWidth / rect.width;
             const scaleY = baseImageNaturalHeight / rect.height;
             const x = (event.clientX - rect.left) * scaleX;
             const y = (event.clientY - rect.top) * scaleY;

             let hoveredLayerId = null;

             // Check interactive layers from top z-index down
             // Skeleton layers are 1 to N, canvases are 101 to 100+N
             const interactiveLayers = skeletonLayers.filter(l => l.interactive);
             // Iterate through layers in reverse order of zIndex to check top layer first
              interactiveLayers.sort((a, b) => (b.zIndex || 1) - (a.zIndex || 1));

             for (const layer of interactiveLayers) {
                 const canvas = canvasElements[layer.id];
                 const ctx = canvasContexts[layer.id];
                 const img = imageElements[layer.id];

                 if (!canvas || !ctx || !img || img.classList.contains('hidden')) continue; // Skip if no canvas, context, image, or hidden

                 // Need to scale mouse coordinates to the specific layer's canvas dimensions
                 const layerRect = img.getBoundingClientRect();
                 const layerScaleX = img.naturalWidth / layerRect.width;
                 const layerScaleY = img.naturalHeight / layerRect.height;
                 const layerX = (event.clientX - layerRect.left) * layerScaleX;
                 const layerY = (event.clientY - layerRect.top) * layerScaleY;


                 // Check pixel data on the canvas
                 if (layerX >= 0 && layerX < canvas.width && layerY >= 0 && layerY < canvas.height) {
                     try {
                        const pixel = ctx.getImageData(layerX, layerY, 1, 1).data;
                        // Check if the pixel is not fully transparent (alpha > 0)
                        if (pixel[3] > 0) {
                            hoveredLayerId = layer.id;
                            break; // Found the top-most non-transparent pixel
                        }
                     } catch (e) {
                         console.error(`Error getting pixel data for ${layer.id}:`, e);
                         // Continue to the next layer if there's an error with this one
                     }
                 }
             }

             if (hoveredLayerId !== activeLayerId) {
                 // Remove glow from the previously active layer
                 if (activeLayerId && imageElements[activeLayerId]) {
                     imageElements[activeLayerId].classList.remove('glowing');
                 }

                 // Add glow to the new active layer
                 if (hoveredLayerId && imageElements[hoveredLayerId]) {
                     imageElements[hoveredLayerId].classList.add('glowing');
                 }

                 activeLayerId = hoveredLayerId;
             }
         }

         function handleContainerMouseLeave() {
             if (activeLayerId && imageElements[activeLayerId]) {
                 imageElements[activeLayerId].classList.remove('glowing');
             }
             activeLayerId = null;
         }

         function handleContainerClick() {
              if (currentMode !== 'default' || loadingIndicator.style.display !== 'none') {
                 return; // Only active in default mode and when loaded
              }

             if (activeLayerId) {
                 const layer = skeletonLayers.find(l => l.id === activeLayerId);
                 if (layer) {
                     showSidebar(layer.name, layer.gifSrc, layer.info);
                 }
             }
         }

        // --- Sidebar Management ---

        function showSidebar(title, imageSrc, content, links = []) {
            sidebarTitle.textContent = title;
            let contentHTML = '';

            if (imageSrc) {
                 // Determine if it's a GIF or a static image based on extension
                 const imgClass = imageSrc.toLowerCase().endsWith('.gif') ? 'popup-gif' : 'popup-image';
                 contentHTML += `<img src="${imageSrc}" alt="${title}" class="${imgClass}">`;
             }

            contentHTML += `<div class="info-text">${content}</div>`;

            if (links.length > 0) {
                contentHTML += '<h5>Learn More:</h5><ul>';
                links.forEach(link => {
                    contentHTML += `<li><a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.text}</a></li>`;
                });
                contentHTML += '</ul>';
            }


             // If showing the 'about' section, add credits
             if (currentMode === 'about') {
                 // The credits are already included in the about info string
             }


            sidebarContent.innerHTML = contentHTML;
            sidebar.classList.add('visible');
        }

        function closeSidebar() {
            sidebar.classList.remove('visible');
             // Clear content when closing
             sidebarTitle.textContent = '';
             sidebarContent.innerHTML = '';
        }

         // --- Error Handling ---
         function showError(message, fatal = false) {
             console.error("Error:", message);
             const errorDiv = document.createElement('div');
             errorDiv.style.cssText = `
                 position: fixed;
                 bottom: 20px;
                 left: 50%;
                 transform: translateX(-50%);
                 background-color: ${fatal ? 'darkred' : 'darkorange'};
                 color: white;
                 padding: 10px 20px;
                 border-radius: 5px;
                 z-index: 10001;
                 font-size: 0.9em;
                 opacity: 0.9;
             `;
             errorDiv.textContent = message;
             document.body.appendChild(errorDiv);

             // Remove non-fatal errors after a few seconds
             if (!fatal) {
                 setTimeout(() => {
                     errorDiv.remove();
                 }, 5000);
             }
         }


        // --- Start the application ---
        init();

    </script>
</body>
</html>